%ELE549 Homework #2
%% Prob #2: Throughput Simulation
T = 1e5;
N_arr = [40 100];
TTMA = zeros(numel(N_arr),T); % Total Transmissions Moving Average

for idx = 1:numel(N_arr)
    numLambda = N_arr(idx);
    P = ones(numLambda,T);
    Ev = zeros(numLambda,1);
    total_transmissions = zeros(1,T);

    for t = 1:(T-1)
        for n = 1:numLambda
            Ev(n,1) = rand < P(n,t);
        end
        total_transmissions(1,t) = sum(Ev(:,1));
        if total_transmissions(1,t) == 0
            P(:,t+1) = min(1.2*P(:,t),1);
        elseif total_transmissions(1,t) > 1
            P(:,t+1) = 0.8*P(:,t);
        end
        TTMA(idx,t) = sum(total_transmissions(1,1:t))/t;
    end
end

%% Prob #2 Graphing
t = 1:T;
plot(t,TTMA(1,:))
hold on
xlabel("Time (t)")
ylabel("Throughput (transmissions/t)")
title("Running Average of Throughput for N = 40, N = 100")
plot(t,TTMA(2,:))
legend("N = 40","N = 100")
hold off

%% Prob #3a: Geo/Geo/1 simulation
T = 1e5; %num timesteps
mu = 0.5; %mu (prob service)
i = 1;
numLambda = 100; % num lambda steps
numTrials = 500; % num trials to avg
geoMeanQueueLen = zeros(1,numLambda);

geoExpectedQueueLen = zeros(1,numLambda); %expected queue len
lambda = linspace(0,0.475,numLambda);

while i <= numLambda
    roh = ((lambda(i)*(1-mu))/(mu*(1-lambda(i))));
    geoExpectedQueueLen(1,i) = roh/(1-roh);
    geoMeanQueueLen(1,i) = geogeo1sim(T,numTrials,lambda(i),mu);
    i=i+1;
end

%% Prob #3b: Geo/Geo/1 graphing
plot(lambda,geoMeanQueueLen,'rx')
xlabel("\lambda")
ylabel("Average Queue Length")
hold on;
plot(lambda,geoExpectedQueueLen)
hold off;
title("Geo/Geo/1 Queue");
legend("mean simulated queue len","mean expected queue len",'Location','NorthWest');

%% Prob #3c: Geo/Det/1 simulation
T = 1e5; %num timesteps
i = 1;
numLambda = 100; %num lambda steps
numTrials = 500; %num trials to average

detMeanQueueLen = zeros(1,numLambda);

detExpectedQueueLen = zeros(1,numLambda); %expected queue len
lambda = linspace(0,0.475,numLambda);

while i <= numLambda

    roh = ((lambda(i))/(1-lambda(i)));
    detExpectedQueueLen(1,i) = roh/(1-roh);
    detMeanQueueLen(1,i) = geod1sim(T,numTrials,lambda(i),1);
    i=i+1;
end

%% Prob #3c: Geo/Det/1 graphing
plot(lambda,detMeanQueueLen,'rx')
xlabel("\lambda")
ylabel("E[\lambda] (Average Queue Length)")
hold on;
plot(lambda,detExpectedQueueLen)
hold off;
title("Geo/Det/1 Queue");
legend("mean simulated queue len","mean expected queue len",'Location','NorthWest');

%% Prob #3d: Geo/Exp/1 simulation
T = 1e5; %num timesteps
i = 1;
numLambda = 100; %num lambda steps
numTrials = 500; %num trials to average
M_arr = [1 5]

expMeanQueueLen = zeros(numel(M_arr),numLambda);

for idx = 1:numel(M_arr),T
    m = M
    % expExpectedQueueLen = zeros(1,numLambda); %expected queue len
    lambda = linspace(0,0.475,numLambda);
    
    while i <= numLambda
        
        %     roh = ((lambda(i))/(1-lambda(i)));
        %     expExpectedQueueLen(1,i) = roh/(1-roh);
        expMeanQueueLen(1,i) = geod1sim(T,numTrials,lambda(i),1);
        i=i+1;
    end
end

%% Geo/D/1 G/G/1 G/X/1 Comparison
T = 1e5; %num timesteps
i = 1;
numLambda = 100; %num lambda steps
numTrials = 500; %num trials to average
mu = 0.5; %mu (prob service)

geoMeanQueueLen = zeros(1,numLambda);
detMeanQueueLen = zeros(1,numLambda);

geoExpectedQueueLen = zeros(1,numLambda); %expected queue len
detExpectedQueueLen = zeros(1,numLambda); %expected queue len
lambda = linspace(0,0.475,numLambda);

while i <= numLambda
    roh = ((lambda(i)*(1-mu))/(mu*(1-lambda(i))));
    roh1 = ((lambda(i))/(1-lambda(i)));
    geoExpectedQueueLen(1,i) = roh/(1-roh);
    detExpectedQueueLen(1,i) = roh1/(1-roh1);
    geoMeanQueueLen(1,i) = geogeo1sim(T,numTrials,lambda(i),mu);
    detMeanQueueLen(1,i) = geod1sim(T,numTrials,lambda(i),1);
    i=i+1;
end
%%
%adjust geod1sim vals to represent queuelength not packets left
hold on;
plot(lambda,geoMeanQueueLen, 'ro')
plot(lambda,detMeanQueueLen, 'bx')
plot(lambda,geoExpectedQueueLen,'r')
plot(lambda,detExpectedQueueLen,'b')
xlabel("\lambda")
ylabel("E(\lambda) (Average Queue Length)")
title("Geo/Geo/1 Queue vs Geo/D/1 Queue");
legend("mean simulated queue len (G/G/1)","mean simulated queue len (G/D/1)","mean expected queue len (G/G/1)","mean expected queue len (G/D/1)",'Location','NorthWest');
hold off;